<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>BÃ¼tÃ§e Takip Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2 class="text-center mb-4 fw-bold text-primary">ğŸ“Š KiÅŸisel BÃ¼tÃ§e Paneli</h2>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">â• HÄ±zlÄ± Harcama Ekle</h5>
                </div>
                <div class="card-body">
                    <form id="harcamaFormu">
                        <div class="mb-3">
                            <label class="form-label">AÃ§Ä±klama</label>
                            <input type="text" id="aciklama" class="form-control" placeholder="Ã–rn: Market" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tutar (TL)</label>
                            <input type="number" step="0.01" id="tutar" class="form-control" placeholder="0.00" required>
                        </div>
                        <div class="mb-3">
                             <label class="form-label">Kategori</label>
                            <select id="kategoriSelect" class="form-select" required>
                                <option value="" selected disabled>SeÃ§iniz...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">ğŸ’¾ Kaydet</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ğŸ© Kategori DaÄŸÄ±lÄ±mÄ±</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ’¸ Son Harcamalar</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover table-striped align-middle">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Kategori</th>
                    <th>Tutar</th>
                    <th>Tarih</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
                </thead>
                <tbody id="tabloGovdesi">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // KÃ¼resel deÄŸiÅŸkenler
    let myChart = null;

    document.addEventListener("DOMContentLoaded", function() {
        kategorileriGetir();
        harcamalariGetir();
        grafigiCiz(); // Sayfa aÃ§Ä±lÄ±nca grafiÄŸi de Ã§iz
    });

    // --- GRAFÄ°K Ã‡Ä°ZME FONKSÄ°YONU (YENÄ°!) ---
    function grafigiCiz() {
        // 1. Backend'den Ã¶zet veriyi Ã§ek
        fetch('/api/transactions/chart-data')
            .then(response => response.json())
            .then(data => {
                // Gelen veriyi Chart.js'in anlayacaÄŸÄ± formata Ã§evir
                const etiketler = data.map(item => item.categoryName); // ["Mutfak", "Fatura"]
                const tutarlar = data.map(item => item.totalAmount);   // [450.50, 1200.00]
                
                // Renk paleti (Otomatik renkler)
                const renkler = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                ];

                // 2. EÄŸer eski grafik varsa yok et (Ã¼st Ã¼ste binmesin diye)
                if (myChart != null) {
                    myChart.destroy();
                }

                // 3. Yeni grafiÄŸi oluÅŸtur
                const ctx = document.getElementById('myPieChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'doughnut', // 'pie' da yapabilirsin
                    data: {
                        labels: etiketler,
                        datasets: [{
                            data: tutarlar,
                            backgroundColor: renkler,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            });
    }

    // --- MEVCUT FONKSÄ°YONLAR (AynÄ± kaldÄ±) ---
    function kategorileriGetir() {
        fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('kategoriSelect');
                // Mevcut seÃ§enekleri temizle (ilk seÃ§enek hariÃ§)
                 while (select.options.length > 1) { select.remove(1); }
                data.forEach(kat => {
                    const opt = document.createElement('option');
                    opt.value = kat.id;
                    opt.text = kat.name;
                    select.appendChild(opt);
                });
            });
    }

    function harcamalariGetir() {
        fetch('/api/transactions')
            .then(res => res.json())
            .then(data => {
                const tablo = document.getElementById('tabloGovdesi');
                tablo.innerHTML = "";
                data.forEach(h => {
                    const satir = `
                        <tr>
                            <td>${h.id}</td>
                            <td>${h.description}</td>
                            <td><span class="badge bg-secondary">${h.category ? h.category.name : '-'}</span></td>
                            <td class="fw-bold text-danger">${h.amount} â‚º</td>
                            <td>${h.date}</td>
                            <td><button class="btn btn-sm btn-outline-danger" onclick="harcamaSil(${h.id})">SilğŸ—‘ï¸</button></td>
                        </tr>`;
                    tablo.innerHTML += satir;
                });
            });
    }

    function harcamaSil(id) {
        if (confirm("Silmek istediÄŸine emin misin?")) {
            fetch('/api/transactions/' + id, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    harcamalariGetir();
                    grafigiCiz(); // Silince grafiÄŸi de gÃ¼ncelle!
                } else alert("Hata oluÅŸtu.");
            });
        }
    }

    document.getElementById('harcamaFormu').addEventListener('submit', function(e) {
        e.preventDefault();
        const veri = {
            description: document.getElementById('aciklama').value,
            amount: parseFloat(document.getElementById('tutar').value),
            userId: 1,
            category: { id: parseInt(document.getElementById('kategoriSelect').value) }
        };
        fetch('/api/transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(veri)
        }).then(async res => {
            if (res.ok) {
                this.reset();
                harcamalariGetir();
                grafigiCiz(); // Yeni ekleyince grafiÄŸi gÃ¼ncelle!
                kategorileriGetir(); // Dropdown'Ä± taze tut
            } else alert("Hata: " + await res.text());
        });
    });
</script>

</body>
</html>